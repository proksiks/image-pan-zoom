(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const h of s.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&e(h)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();class b{container;content;options;scale;x;y;rotation;isPanning=!1;didMove=!1;startClientX=0;startClientY=0;startX=0;startY=0;velocityX=0;velocityY=0;velocityScale=0;lastMoveTime=0;lastClientX=0;lastClientY=0;lastScale=1;animationFrameId=null;DRAG_THRESHOLD=3;touchStartDistance=0;touchStartScale=1;touchCenterX=0;touchCenterY=0;isPinching=!1;lastTouchCenterX=0;lastTouchCenterY=0;transitionDuration=300;transitionEasing="ease-out";isTransitioning=!1;transitionTimeout=null;lastTouchEndTime=0;lastTouchX=0;lastTouchY=0;DOUBLE_TAP_DELAY=300;DOUBLE_TAP_THRESHOLD=10;boundWheel;boundPointerDown;boundPointerMove;boundPointerUp;boundDoubleClick;boundTouchStart;boundTouchMove;boundTouchEnd;constructor(t,i,e={}){this.container=t,this.content=i,this.options={minScale:e.minScale??.5,maxScale:e.maxScale??3,initialScale:e.initialScale??1,wheelZoomSpeed:e.wheelZoomSpeed??.0015,boundsPadding:e.boundsPadding??.1,friction:e.friction??.92,maxSpeed:e.maxSpeed??300,transition:e.transition??!1,pinchSpeed:e.pinchSpeed??1},this.scale=this.options.initialScale,this.x=0,this.y=0,this.rotation=0,this.lastScale=this.options.initialScale,this.boundWheel=this.onWheel.bind(this),this.boundPointerDown=this.onPointerDown.bind(this),this.boundPointerMove=this.onPointerMove.bind(this),this.boundPointerUp=this.onPointerUp.bind(this),this.boundDoubleClick=this.onDoubleClick.bind(this),this.boundTouchStart=this.onTouchStart.bind(this),this.boundTouchMove=this.onTouchMove.bind(this),this.boundTouchEnd=this.onTouchEnd.bind(this),this.init()}init(){this.content.style.touchAction="none",this.content.style.userSelect="none",this.applyTransform(),this.attachEvents()}attachEvents(){this.container.addEventListener("wheel",this.boundWheel,{passive:!1}),this.content.addEventListener("pointerdown",this.boundPointerDown),this.content.addEventListener("dblclick",this.boundDoubleClick),window.addEventListener("pointermove",this.boundPointerMove),window.addEventListener("pointerup",this.boundPointerUp),this.container.addEventListener("touchstart",this.boundTouchStart,{passive:!1}),this.container.addEventListener("touchmove",this.boundTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.boundTouchEnd,{passive:!1})}getSizes(){const t=this.container.getBoundingClientRect(),i=t.width,e=t.height,n=Math.min(i,e)*this.options.boundsPadding,s=this.content.offsetWidth,h=this.content.offsetHeight;return{contW:i,contH:e,pad:n,w:s*this.scale,h:h*this.scale}}clampPosition(t,i){const{contW:e,contH:n,pad:s,w:h,h:c}=this.getSizes(),l=h<=e,r=c<=n;let u,d,m,f;if(l)u=d=0;else{const y=e/2,v=h/2;d=v-y+s,u=-(v-y)-s}if(r)m=f=0;else{const y=n/2,v=c/2;f=v-y+s,m=-(v-y)-s}return{x:l?0:Math.min(d,Math.max(u,t)),y:r?0:Math.min(f,Math.max(m,i))}}applyTransform(t=!1){this.container.style.overflow="hidden",this.container.style.position||(this.container.style.position="relative"),this.container.style.minHeight="25vh",this.content.style.position="absolute",this.content.style.top="50%",this.content.style.left="50%",this.content.style.transformOrigin="50% 50%";const i=this.clampPosition(this.x,this.y);this.x=i.x,this.y=i.y,this.options.transition&&t&&!this.isTransitioning?(this.content.style.transition=`transform ${this.transitionDuration}ms ${this.transitionEasing}`,this.isTransitioning=!0,this.transitionTimeout&&clearTimeout(this.transitionTimeout),this.transitionTimeout=window.setTimeout(()=>{this.content.style.transition="",this.isTransitioning=!1,this.transitionTimeout=null},this.transitionDuration)):t||(this.content.style.transition="none",this.isTransitioning=!1),this.content.style.transform=`translate(-50%, -50%) translate(${this.x}px, ${this.y}px) rotate(${this.rotation}deg) scale(${this.scale})`}clampScale(t){return Math.min(this.options.maxScale,Math.max(this.options.minScale,t))}stopAnimation(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}zoomToPoint(t,i,e){const n=this.container.getBoundingClientRect(),s=this.scale,h=this.clampScale(s*e);if(h===s)return;const c=t-n.left,l=i-n.top,r=n.width/2,u=n.height/2,d=c-r-this.x,m=l-u-this.y,f=h/s,y=d*f,v=m*f;this.scale=h,this.x+=d-y,this.y+=m-v,this.applyTransform(!1)}moveTo(t,i,e){this.stopAnimation();const n=this.container.getBoundingClientRect(),s=n.width/2,h=n.height/2;this.x=t-s,this.y=i-h;const c=this.clampPosition(this.x,this.y);this.x=c.x,this.y=c.y;const l=e===void 0||e;this.applyTransform(l&&this.options.transition)}moveBy(t,i,e){this.stopAnimation(),this.x+=t,this.y+=i;const n=this.clampPosition(this.x,this.y);this.x=n.x,this.y=n.y;const s=e===void 0||e;this.applyTransform(s&&this.options.transition)}zoomTo(t,i,e,n){this.stopAnimation();const s=this.container.getBoundingClientRect(),h=i!==void 0?i:s.width/2,c=e!==void 0?e:s.height/2,l=this.scale,r=this.clampScale(t);if(r===l)return;const u=s.width/2,d=s.height/2,m=h-u-this.x,f=c-d-this.y,y=r/l,v=m*y,S=f*y;this.scale=r,this.x+=m-v,this.y+=f-S;const w=n===void 0||n;this.applyTransform(w&&this.options.transition)}animateKinetic=()=>{if(Math.abs(this.velocityX)<.5&&Math.abs(this.velocityY)<.5&&Math.abs(this.velocityScale)<.001)return this.stopAnimation(),void this.applyTransform(!1);this.x+=this.velocityX,this.y+=this.velocityY,this.scale+=this.velocityScale,this.scale=this.clampScale(this.scale),this.velocityX*=this.options.friction,this.velocityY*=this.options.friction,this.velocityScale*=this.options.friction,this.applyTransform(!1),this.animationFrameId=requestAnimationFrame(this.animateKinetic)};onWheel(t){t.preventDefault(),this.stopAnimation(),this.velocityX=0,this.velocityY=0,this.velocityScale=0;const i=1+-t.deltaY*this.options.wheelZoomSpeed;i!==0&&this.zoomToPoint(t.clientX,t.clientY,i)}onPointerDown(t){t.button===0&&(this.stopAnimation(),this.isPanning=!0,this.didMove=!1,this.startClientX=t.clientX,this.startClientY=t.clientY,this.startX=this.x,this.startY=this.y,this.lastClientX=t.clientX,this.lastClientY=t.clientY,this.lastScale=this.scale,this.lastMoveTime=Date.now(),this.velocityX=0,this.velocityY=0,this.velocityScale=0,this.content.setPointerCapture(t.pointerId))}onPointerMove(t){if(!this.isPanning)return;const i=t.clientX-this.startClientX,e=t.clientY-this.startClientY;if(!this.didMove&&Math.hypot(i,e)<this.DRAG_THRESHOLD)return;this.didMove=!0;const n=this.startX+i,s=this.startY+e;this.x=n,this.y=s;const h=Date.now(),c=h-this.lastMoveTime;if(c>0){const l=(t.clientX-this.lastClientX)/c*16,r=(t.clientY-this.lastClientY)/c*16,u=(this.scale-this.lastScale)/c*16;this.velocityX=Math.max(-this.options.maxSpeed,Math.min(this.options.maxSpeed,l)),this.velocityY=Math.max(-this.options.maxSpeed,Math.min(this.options.maxSpeed,r)),this.velocityScale=Math.max(-.01,Math.min(.01,u))}this.lastClientX=t.clientX,this.lastClientY=t.clientY,this.lastScale=this.scale,this.lastMoveTime=h,this.applyTransform(!1)}onPointerUp(t){if(this.isPanning){this.isPanning=!1;try{this.content.releasePointerCapture(t.pointerId)}catch{}this.didMove&&(Math.abs(this.velocityX)>1||Math.abs(this.velocityY)>1||Math.abs(this.velocityScale)>.001)&&(this.animationFrameId=requestAnimationFrame(this.animateKinetic))}}onDoubleClick(t){this.stopAnimation();const i=this.container.getBoundingClientRect(),e=i.width/2,n=i.height/2,s=t.clientX-i.left,h=t.clientY-i.top,c=Math.min(1.5*this.scale,this.options.maxScale),l=c/this.scale,r=s-e-this.x,u=h-n-this.y;this.scale=c;const d=r*l,m=u*l;this.x+=r-d,this.y+=u-m,this.applyTransform(!0)}onTouchStart(t){if(t.touches.length===2){t.preventDefault(),this.stopAnimation(),this.isPinching=!0,this.velocityX=0,this.velocityY=0,this.velocityScale=0;const i=t.touches[0],e=t.touches[1],n=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY);this.touchCenterX=(i.clientX+e.clientX)/2,this.touchCenterY=(i.clientY+e.clientY)/2,this.lastTouchCenterX=this.touchCenterX,this.lastTouchCenterY=this.touchCenterY,this.touchStartDistance=n,this.touchStartScale=this.scale,this.isPanning=!1,this.didMove=!1}else if(t.touches.length===1){const i=t.touches[0],e=new PointerEvent("pointerdown",{clientX:i.clientX,clientY:i.clientY,button:0});this.onPointerDown(e)}}onTouchMove(t){if(t.touches.length===2&&this.isPinching){t.preventDefault();const i=t.touches[0],e=t.touches[1],n=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY),s=(i.clientX+e.clientX)/2,h=(i.clientY+e.clientY)/2,c=n/this.touchStartDistance,l=this.touchStartScale*c*this.options.pinchSpeed,r=this.clampScale(l);if(r!==this.scale){const u=s-this.lastTouchCenterX,d=h-this.lastTouchCenterY;this.x+=u,this.y+=d;const m=r/this.scale;this.zoomToPoint(this.touchCenterX,this.touchCenterY,m),this.lastTouchCenterX=s,this.lastTouchCenterY=h}}else if(t.touches.length===1&&!this.isPinching){const i=t.touches[0],e=new PointerEvent("pointermove",{clientX:i.clientX,clientY:i.clientY});this.onPointerMove(e)}}onTouchEnd(t){if(this.isPinching&&t.touches.length<2){this.isPinching=!1;const i=Date.now()-this.lastMoveTime;if(i>0&&i<100){const e=(this.lastTouchCenterX-this.touchCenterX)/i*16,n=(this.lastTouchCenterY-this.touchCenterY)/i*16;this.velocityX=Math.max(-this.options.maxSpeed,Math.min(this.options.maxSpeed,e)),this.velocityY=Math.max(-this.options.maxSpeed,Math.min(this.options.maxSpeed,n)),(Math.abs(this.velocityX)>1||Math.abs(this.velocityY)>1)&&(this.animationFrameId=requestAnimationFrame(this.animateKinetic))}}if(t.touches.length===0){if(this.isPanning){const i=new PointerEvent("pointerup",{clientX:0,clientY:0,button:0});this.onPointerUp(i)}this.isPinching=!1,this.handleDoubleTapCheck(t)}}handleDoubleTapCheck(t){const i=Date.now(),e=t.changedTouches[0];if(!e)return;const n=e.clientX,s=e.clientY;i-this.lastTouchEndTime<this.DOUBLE_TAP_DELAY&&Math.abs(n-this.lastTouchX)<this.DOUBLE_TAP_THRESHOLD&&Math.abs(s-this.lastTouchY)<this.DOUBLE_TAP_THRESHOLD?(this.handleDoubleTap(n,s),this.lastTouchEndTime=0,this.lastTouchX=0,this.lastTouchY=0):(this.lastTouchEndTime=i,this.lastTouchX=n,this.lastTouchY=s)}handleDoubleTap(t,i){this.stopAnimation();const e=this.container.getBoundingClientRect(),n=e.width/2,s=e.height/2,h=t-e.left,c=i-e.top,l=Math.min(1.5*this.scale,this.options.maxScale),r=l/this.scale,u=h-n-this.x,d=c-s-this.y;this.scale=l;const m=u*r,f=d*r;this.x+=u-m,this.y+=d-f,this.applyTransform(!0)}reset(){this.stopAnimation(),this.scale=this.options.initialScale,this.x=0,this.y=0,this.rotation=0,this.velocityX=0,this.velocityY=0,this.velocityScale=0,this.applyTransform(!0)}rotate(t){this.rotation=(this.rotation+t)%360,this.applyTransform(!0)}getTransform(){return{scale:this.scale,x:this.x,y:this.y,rotation:this.rotation}}setTransform(t,i){t.scale!==void 0&&(this.scale=this.clampScale(t.scale)),t.x!==void 0&&(this.x=t.x),t.y!==void 0&&(this.y=t.y),t.rotation!==void 0&&(this.rotation=t.rotation);const e=i===void 0||i;this.applyTransform(e&&this.options.transition)}getViewportBounds(){const t=this.container.getBoundingClientRect(),i=t.width/2,e=t.height/2;return{left:i+this.x,top:e+this.y,right:i+this.x,bottom:e+this.y}}containerToImage(t,i){const e=this.container.getBoundingClientRect(),n=this.content.getBoundingClientRect(),s=e.width/2,h=e.height/2,c=t-s-this.x,l=i-h-this.y;return{x:c/this.scale+n.width/2/this.scale,y:l/this.scale+n.height/2/this.scale}}imageToContainer(t,i){const e=this.container.getBoundingClientRect(),n=this.content.getBoundingClientRect(),s=e.width/2,h=e.height/2,c=(t-n.width/2/this.scale)*this.scale,l=(i-n.height/2/this.scale)*this.scale;return{x:s+this.x+c,y:h+this.y+l}}centerOnImagePoint(t,i,e){const n=this.imageToContainer(t,i);this.moveTo(n.x,n.y,e)}destroy(){this.stopAnimation(),this.transitionTimeout&&(clearTimeout(this.transitionTimeout),this.transitionTimeout=null),this.container.removeEventListener("wheel",this.boundWheel),this.content.removeEventListener("pointerdown",this.boundPointerDown),this.content.removeEventListener("dblclick",this.boundDoubleClick),window.removeEventListener("pointermove",this.boundPointerMove),window.removeEventListener("pointerup",this.boundPointerUp),this.container.removeEventListener("touchstart",this.boundTouchStart),this.container.removeEventListener("touchmove",this.boundTouchMove),this.container.removeEventListener("touchend",this.boundTouchEnd),this.content.style.transform="",this.content.style.touchAction=""}}function C(o,t,i){return new b(o,t,i)}let a,g=!0;const T=document.getElementById("event-log");function p(o){const t=document.createElement("div");t.className="event-item",t.textContent=`[${new Date().toLocaleTimeString()}] ${o}`,T.prepend(t),T.children.length>10&&T.removeChild(T.lastChild)}function x(){if(a){const o=a.getTransform();document.getElementById("scale-value").textContent=o.scale.toFixed(2),document.getElementById("x-value").textContent=o.x.toFixed(2),document.getElementById("y-value").textContent=o.y.toFixed(2),document.getElementById("rotation-value").textContent=`${o.rotation.toFixed(0)}°`}}function E(){const o=document.getElementById("image-container"),t=document.getElementById("image");a&&a.destroy(),a=C(o,t,{minScale:.1,maxScale:10,initialScale:1,wheelZoomSpeed:.0015,boundsPadding:.1,friction:.92,maxSpeed:300,transition:g,pinchSpeed:1});const i=a.applyTransform;a.applyTransform=function(e){i.call(this,e),x()},p("ImagePanZoom инициализирован"),x()}window.moveTo=function(o,t){a&&(a.moveTo(parseFloat(o),parseFloat(t)),p(`moveTo(${o}, ${t})`))};window.moveBy=function(o,t){a&&(a.moveBy(parseFloat(o),parseFloat(t)),p(`moveBy(${o}, ${t})`))};window.moveToCustom=function(){const o=document.getElementById("move-x").value,t=document.getElementById("move-y").value;moveTo(o,t)};window.zoomTo=function(o){a&&(a.zoomTo(parseFloat(o)),p(`zoomTo(${o})`))};window.zoomToCustom=function(){const o=document.getElementById("zoom-scale").value;zoomTo(o)};window.zoomIn=function(){if(!a)return;const o=a.getTransform(),t=Math.min(o.scale*1.2,10);a.zoomTo(t),p(`zoomIn (${o.scale.toFixed(2)} → ${t.toFixed(2)})`)};window.zoomOut=function(){if(!a)return;const o=a.getTransform(),t=Math.max(o.scale*.8,.1);a.zoomTo(t),p(`zoomOut (${o.scale.toFixed(2)} → ${t.toFixed(2)})`)};window.rotateBy=function(o){a&&(a.rotate(parseFloat(o)),p(`rotateBy(${o}°)`))};window.rotateTo=function(o){a&&(a.setTransform({rotation:parseFloat(o)}),p(`rotateTo(${o}°)`))};window.centerOnImagePointCustom=function(){if(!a)return;const o=document.getElementById("image"),t=Math.random()*o.naturalWidth,i=Math.random()*o.naturalHeight;a.centerOnImagePoint(t,i),p(`centerOnImagePoint(${t.toFixed(0)}, ${i.toFixed(0)})`)};window.resetTransform=function(){a&&(a.reset(),p("reset()"))};window.getTransformState=function(){if(!a)return;const o=a.getTransform();p(`getTransform(): scale=${o.scale.toFixed(2)}, x=${o.x.toFixed(2)}, y=${o.y.toFixed(2)}, rotation=${o.rotation}°`),alert(JSON.stringify(o,null,2))};document.getElementById("toggle-transition").addEventListener("change",function(o){g=o.target.checked,a&&(a.options.transition=g,p(`Transition: ${g?"включено":"выключено"}`))});document.addEventListener("DOMContentLoaded",()=>{E(),setInterval(x,100);const o=document.getElementById("image-container");o.addEventListener("click",t=>{const i=o.getBoundingClientRect(),e=t.clientX-i.left,n=t.clientY-i.top;if(document.getElementById("move-x").value=Math.round(e),document.getElementById("move-y").value=Math.round(n),a){const s=a.containerToImage(e,n);p(`Клик: контейнер(${e.toFixed(0)}, ${n.toFixed(0)}) → изображение(${s.x.toFixed(0)}, ${s.y.toFixed(0)})`)}}),p("Демо загружено. Готово к работе!")});
